name: AI PR Analyzer

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  analyze-pr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get PR diff
      id: diff
      run: |
        git fetch origin ${{ github.base_ref }}
        DIFF=$(git diff origin/${{ github.base_ref }}...HEAD | head -c 10000)
        echo "diff<<EOF" >> $GITHUB_OUTPUT
        echo "$DIFF" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Analyze PR with AI
      id: ai_analysis
      uses: ./.github/workflows/00-ai-orchestrator-reusable.yml
      with:
        task_type: "pr_analysis"
        system_message: |
          You are an expert code reviewer. Analyze this pull request and provide:
          1. Summary of changes
          2. Potential issues or bugs
          3. Security concerns
          4. Performance implications
          5. Suggestions for improvement
          
          Be constructive and specific.
        user_prompt: |
          Pull Request: ${{ github.event.pull_request.title }}
          Description: ${{ github.event.pull_request.body }}
          
          Changes:
          ${{ steps.diff.outputs.diff }}
        max_tokens: 3000
        temperature: 0.3
    
    - name: Post review comment
      uses: actions/github-script@v7
      if: steps.ai_analysis.outputs.success == 'true'
      with:
        script: |
          const body = `## ðŸ¤– AI Code Review
          
          **Analyzed by**: ${{ steps.ai_analysis.outputs.provider }}
          **Analysis time**: ${{ steps.ai_analysis.outputs.duration_ms }}ms
          **Providers tried**: ${{ steps.ai_analysis.outputs.fallback_count }}
          
          ---
          
          ${{ steps.ai_analysis.outputs.response }}
          
          ---
          
          *This analysis was generated by AI. Human review is still recommended.*
          `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: body
          });
