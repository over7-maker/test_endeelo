name: "üîç AI PR Deep Analyzer"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  analyze-pr:
    name: "Deep PR Analysis"
    runs-on: ubuntu-latest
    
    steps:
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: "üêç Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: "üì¶ Install Dependencies"
        run: |
          pip install --upgrade pip
          pip install requests pyyaml python-dateutil
      
      - name: "üìù Get PR Diff"
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD | head -c 8000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: "ü§ñ Analyze PR with 15-Tier AI Fallback"
        id: ai_analysis
        env:
          GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
          GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
          GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
          GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        run: |
          python3 <<'PYTHON_SCRIPT'
          import sys
          import os
          sys.path.insert(0, '.github/scripts')
          from ai_api_fallback import ai_call
          
          pr_title = """${{ github.event.pull_request.title }}"""
          pr_body = """${{ github.event.pull_request.body }}"""
          pr_diff = """${{ steps.diff.outputs.diff }}"""
          
          system_prompt = """
          You are an expert code reviewer specializing in comprehensive PR analysis.
          
          Provide a structured review with:
          1. **Summary**: High-level overview of changes
          2. **Code Quality**: Structure, readability, maintainability
          3. **Potential Issues**: Bugs, edge cases, logic errors
          4. **Security**: Vulnerabilities, input validation, authentication
          5. **Performance**: Efficiency concerns, scalability
          6. **Best Practices**: Coding standards, patterns
          7. **Recommendations**: Specific improvements
          
          Be constructive, specific, and actionable. Use emojis for clarity.
          """
          
          user_prompt = f"""
          Pull Request Analysis Request:
          
          Title: {pr_title}
          Description: {pr_body}
          
          Code Changes:
          ```diff
          {pr_diff}
          ```
          
          Please provide a comprehensive code review.
          """
          
          try:
              response = ai_call(user_prompt, system_prompt, max_tokens=2500, temperature=0.3, task_type="pr_analysis")
              
              print("\n" + "="*80)
              print("ü§ñ AI PR ANALYSIS COMPLETE")
              print("="*80)
              print(response)
              print("="*80)
              
              with open('pr_analysis.txt', 'w') as f:
                  f.write(response)
              
              with open('analysis_success.txt', 'w') as f:
                  f.write('true')
              
              print("\n‚úÖ PR analysis generated successfully")
              
          except Exception as e:
              print(f"‚ùå PR analysis failed: {e}")
              with open('analysis_success.txt', 'w') as f:
                  f.write('false')
              sys.exit(1)
          PYTHON_SCRIPT
      
      - name: "üí¨ Post Analysis Comment"
        if: hashFiles('analysis_success.txt') != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            const success = fs.readFileSync('analysis_success.txt', 'utf8').trim();
            if (success !== 'true') {
              console.log('‚ùå Analysis failed, skipping comment');
              return;
            }
            
            const analysis = fs.readFileSync('pr_analysis.txt', 'utf8');
            
            const body = `## üîç AI Code Review

${analysis}

---

*ü§ñ Generated by 15-Tier Zero-Failure AI System*
*üìä Analysis powered by multi-provider fallback architecture*
*‚ö†Ô∏è Human review still recommended for critical changes*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });
            
            console.log(`‚úÖ Posted analysis to PR #${context.payload.pull_request.number}`);
      
      - name: "üì§ Upload Analysis"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-analysis-${{ github.event.pull_request.number }}
          path: pr_analysis.txt
          retention-days: 90
