name: AI Orchestrator (Reusable)

on:
  workflow_call:
    inputs:
      task_type:
        description: 'AI task type'
        required: true
        type: string
      system_message:
        description: 'System context'
        required: true
        type: string
      user_prompt:
        description: 'User query'
        required: true
        type: string
      max_tokens:
        description: 'Max response tokens'
        required: false
        type: number
        default: 2000
      temperature:
        description: 'Generation temperature'
        required: false
        type: number
        default: 0.7
      use_cache:
        description: 'Enable caching'
        required: false
        type: boolean
        default: true
    outputs:
      success:
        description: 'Task succeeded'
        value: ${{ jobs.orchestrate.outputs.success }}
      provider:
        description: 'Successful provider'
        value: ${{ jobs.orchestrate.outputs.provider }}
      response:
        description: 'AI response'
        value: ${{ jobs.orchestrate.outputs.response }}
      duration_ms:
        description: 'Execution time (ms)'
        value: ${{ jobs.orchestrate.outputs.duration_ms }}
      fallback_count:
        description: 'Providers tried'
        value: ${{ jobs.orchestrate.outputs.fallback_count }}

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      success: ${{ steps.execute.outputs.success }}
      provider: ${{ steps.execute.outputs.provider }}
      response: ${{ steps.execute.outputs.response }}
      duration_ms: ${{ steps.execute.outputs.duration_ms }}
      fallback_count: ${{ steps.execute.outputs.fallback_count }}
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install aiohttp
    
    - name: Execute AI Orchestrator
      id: execute
      env:
        CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
        CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
        GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
        GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
        COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
      run: |
        python .github/scripts/universal_ai_orchestrator.py \
          --task-type "${{ inputs.task_type }}" \
          --system-message "${{ inputs.system_message }}" \
          --user-prompt "${{ inputs.user_prompt }}" \
          --max-tokens ${{ inputs.max_tokens }} \
          --temperature ${{ inputs.temperature }} \
          ${{ inputs.use_cache == false && '--no-cache' || '' }} \
          --output orchestrator_result.json
        
        # Extract and set outputs
        python -c "
        import json
        with open('orchestrator_result.json') as f:
            d = json.load(f)
        print(f'success={'true' if d.get('success') else 'false'}')
        print(f'provider={d.get('provider', 'none')}')
        print(f'duration_ms={d.get('duration_ms', 0)}')
        print(f'fallback_count={d.get('fallback_count', 0)}')
        " >> $GITHUB_OUTPUT
        
        # Set response (truncated to 60KB for GitHub Actions limit)
        RESPONSE=$(python -c "import json; print(json.load(open('orchestrator_result.json'))['response'][:60000])")
        echo "response<<EOF" >> $GITHUB_OUTPUT
        echo "$RESPONSE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ai-orchestrator-logs-${{ github.run_id }}
        path: |
          orchestrator_result.json
          .github/data/metrics/*.jsonl
        retention-days: 7
