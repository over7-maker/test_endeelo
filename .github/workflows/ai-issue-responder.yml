name: AI Issue Auto-Responder

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  respond:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@ai'))
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Get issue context
      id: context
      run: |
        TITLE="${{ github.event.issue.title }}"
        BODY="${{ github.event.issue.body }}"
        COMMENT="${{ github.event.comment.body }}"
        
        echo "issue_text<<EOF" >> $GITHUB_OUTPUT
        echo "Title: $TITLE" >> $GITHUB_OUTPUT
        echo "Body: $BODY" >> $GITHUB_OUTPUT
        if [ -n "$COMMENT" ]; then
          echo "Latest Comment: $COMMENT" >> $GITHUB_OUTPUT
        fi
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Generate AI response
      id: ai_response
      uses: ./.github/workflows/00-ai-orchestrator-reusable.yml
      with:
        task_type: "issue_response"
        system_message: |
          You are a helpful project assistant. Respond to GitHub issues politely and helpfully.
          - If it's a bug report, acknowledge and ask for details
          - If it's a feature request, show enthusiasm and ask clarifying questions
          - If it's a question, provide a helpful answer
          - Be concise but thorough
        user_prompt: ${{ steps.context.outputs.issue_text }}
        max_tokens: 1500
    
    - name: Post response
      uses: actions/github-script@v7
      if: steps.ai_response.outputs.success == 'true'
      with:
        script: |
          const body = `${{ steps.ai_response.outputs.response }}
          
          ---
          
          *ðŸ¤– Auto-response powered by ${{ steps.ai_response.outputs.provider }} (${${{ steps.ai_response.outputs.duration_ms }}}ms, ${${{ steps.ai_response.outputs.fallback_count }}} providers tried)*
          `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.issue.number,
            body: body
          });
