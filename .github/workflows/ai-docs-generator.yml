name: "ðŸ“š AI Documentation Generator"

on:
  push:
    branches: [main, master, develop]
  schedule:
    - cron: '0 4 * * 0'  # Weekly on Sunday at 4 AM
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-docs:
    name: "Generate Documentation"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
      
      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: "ðŸ“¦ Install Dependencies"
        run: |
          pip install --upgrade pip
          pip install requests pyyaml python-dateutil
      
      - name: "ðŸ“‚ Scan Project Structure"
        id: structure
        run: |
          echo "Scanning project structure..."
          
          # Create project structure summary
          cat > project_structure.txt <<'EOF'
          Project Structure:
          EOF
          
          find . -type f -name '*.py' -o -name '*.yml' -o -name '*.yaml' -o -name '*.md' | \
            grep -v '.git' | head -50 >> project_structure.txt
          
          # Get README if exists
          if [ -f "README.md" ]; then
            echo "\n\nCurrent README.md:" >> project_structure.txt
            head -100 README.md >> project_structure.txt
          fi
          
          cat project_structure.txt
      
      - name: "ðŸ¤– Generate Documentation with 15-Tier AI"
        env:
          GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
          GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
          GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
          GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        run: |
          python3 <<'PYTHON_SCRIPT'
          import sys
          import os
          sys.path.insert(0, '.github/scripts')
          from ai_api_fallback import ai_call
          
          with open('project_structure.txt', 'r') as f:
              structure = f.read()
          
          system_prompt = """
          You are a technical documentation expert.
          
          Generate comprehensive API documentation including:
          1. **Overview**: Project purpose and capabilities
          2. **Architecture**: System design and components
          3. **Installation**: Setup instructions
          4. **Usage**: Code examples and tutorials
          5. **API Reference**: Functions, classes, methods
          6. **Configuration**: Environment variables, settings
          7. **Troubleshooting**: Common issues and solutions
          
          Use clear markdown formatting with code examples.
          """
          
          user_prompt = f"""
          Generate technical documentation for this project:
          
          {structure}
          
          Create comprehensive, well-structured documentation.
          """
          
          try:
              response = ai_call(user_prompt, system_prompt, max_tokens=3000, temperature=0.4, task_type="documentation")
              
              print("\n" + "="*80)
              print("ðŸ“š AI DOCUMENTATION GENERATED")
              print("="*80)
              print(response[:500] + "...")
              print("="*80)
              
              with open('AI_GENERATED_DOCS.md', 'w') as f:
                  f.write("# AI-Generated Documentation\n\n")
                  f.write(response)
                  f.write("\n\n---\n*Generated automatically by AI Documentation System*\n")
              
              print("\nâœ… Documentation generated")
              
          except Exception as e:
              print(f"âŒ Documentation generation failed: {e}")
              sys.exit(1)
          PYTHON_SCRIPT
      
      - name: "ðŸ“¤ Upload Documentation"
        uses: actions/upload-artifact@v4
        with:
          name: ai-generated-docs-${{ github.run_number }}
          path: AI_GENERATED_DOCS.md
          retention-days: 90
