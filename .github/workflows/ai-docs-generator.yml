name: AI Documentation Generator

on:
  push:
    branches: [main]
    paths:
      - '**.py'
      - '**.js'
      - '**.ts'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Scan codebase
      id: scan
      run: |
        # Get all code files
        CODE_FILES=$(find . -name "*.py" -o -name "*.js" -o -name "*.ts" | head -n 30)
        
        SUMMARY=""
        for file in $CODE_FILES; do
          echo "Processing $file..."
          CONTENT=$(cat $file | head -c 3000)
          SUMMARY="$SUMMARY\n\n### $file\n\`\`\`\n$CONTENT\n\`\`\`"
        done
        
        echo "code_summary<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Generate documentation
      id: docs
      uses: ./.github/workflows/00-ai-orchestrator-reusable.yml
      with:
        task_type: "documentation"
        system_message: |
          You are a technical writer creating comprehensive project documentation.
          Generate a detailed README.md with:
          1. Project overview
          2. Architecture description
          3. Installation instructions
          4. Usage examples
          5. API reference
          6. Contributing guidelines
          
          Use markdown formatting with proper headers, code blocks, and examples.
        user_prompt: |
          Generate documentation for this project based on the code:
          
          ${{ steps.scan.outputs.code_summary }}
        max_tokens: 5000
        temperature: 0.4
    
    - name: Update documentation
      if: steps.docs.outputs.success == 'true'
      run: |
        # Backup existing README
        if [ -f README.md ]; then
          cp README.md README.backup.md
        fi
        
        # Write new documentation
        cat > GENERATED_DOCS.md << 'EOF'
        ${{ steps.docs.outputs.response }}
        EOF
        
        echo "ðŸ“š Documentation generated successfully"
        echo "Review GENERATED_DOCS.md before merging"
    
    - name: Create PR with documentation
      uses: peter-evans/create-pull-request@v6
      with:
        commit-message: "ðŸ“š Update auto-generated documentation"
        title: "ðŸ“š AI-Generated Documentation Update"
        body: |
          ## ðŸ¤– Auto-Generated Documentation
          
          This PR contains AI-generated documentation based on the current codebase.
          
          **Generated by**: ${{ steps.docs.outputs.provider }}
          **Generation time**: ${{ steps.docs.outputs.duration_ms }}ms
          **Providers tried**: ${{ steps.docs.outputs.fallback_count }}
          
          Please review and merge if acceptable, or edit as needed.
        branch: docs/auto-generated
        delete-branch: true
        labels: documentation, automated
