name: AI Code Security & Quality Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday 2 AM

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Find Python files
      id: files
      run: |
        FILES=$(find . -name "*.py" -not -path "./.git/*" | head -n 20)
        echo "python_files<<EOF" >> $GITHUB_OUTPUT
        echo "$FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Get file contents
      id: contents
      run: |
        CONTENT=""
        for file in ${{ steps.files.outputs.python_files }}; do
          CONTENT="$CONTENT\n\n### File: $file\n\`\`\`python\n$(cat $file | head -c 5000)\n\`\`\`"
        done
        echo "file_contents<<EOF" >> $GITHUB_OUTPUT
        echo "$CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: AI Security Analysis
      id: security_scan
      uses: ./.github/workflows/00-ai-orchestrator-reusable.yml
      with:
        task_type: "security_scan"
        system_message: |
          You are a security expert analyzing code for vulnerabilities. Focus on:
          1. SQL injection risks
          2. Command injection
          3. Path traversal
          4. Insecure deserialization
          5. Hardcoded secrets
          6. Weak cryptography
          7. Authentication/Authorization issues
          
          Provide specific file:line references and severity levels.
        user_prompt: |
          Scan these Python files for security vulnerabilities:
          
          ${{ steps.contents.outputs.file_contents }}
        max_tokens: 4000
        temperature: 0.2
    
    - name: Create security issue if problems found
      uses: actions/github-script@v7
      if: steps.security_scan.outputs.success == 'true' && contains(steps.security_scan.outputs.response, 'CRITICAL') || contains(steps.security_scan.outputs.response, 'HIGH')
      with:
        script: |
          const title = 'ðŸ”’ Security Scan: Issues Detected';
          const body = `## Security Analysis Report
          
          **Scanned**: ${new Date().toISOString()}
          **Provider**: ${{ steps.security_scan.outputs.provider }}
          **Analysis time**: ${{ steps.security_scan.outputs.duration_ms }}ms
          
          ---
          
          ${{ steps.security_scan.outputs.response }}
          
          ---
          
          *Automated security scan. Please review and address high-priority issues.*
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'automated']
          });
