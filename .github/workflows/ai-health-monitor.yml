name: AI Providers Health Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Test all providers
      id: health_test
      env:
        CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
        CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
        GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
        GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
        COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
      run: |
        python -c "
        import os
        import json
        import asyncio
        import sys
        
        # Import orchestrator
        sys.path.insert(0, '.github/scripts')
        from universal_ai_orchestrator import UniversalAIOrchestrator
        
        async def test_all():
            orchestrator = UniversalAIOrchestrator()
            results = []
            
            # Test each provider
            for provider in orchestrator.providers:
                if not provider.is_available():
                    results.append({
                        'provider': provider.name,
                        'status': 'not_configured',
                        'latency_ms': 0
                    })
                    continue
                
                success, _, latency = await orchestrator._try_provider(
                    provider,
                    'You are a helpful assistant.',
                    'Reply with only: OK',
                    10,
                    0.1
                )
                
                results.append({
                    'provider': provider.name,
                    'status': 'healthy' if success else 'unhealthy',
                    'latency_ms': latency
                })
            
            return results
        
        results = asyncio.run(test_all())
        
        # Generate report
        healthy = [r for r in results if r['status'] == 'healthy']
        print(f'## Health Check Results')
        print(f'**Date**: {datetime.now().isoformat()}')
        print(f'**Healthy providers**: {len(healthy)}/{len(results)}')
        print()
        print('| Provider | Status | Latency (ms) |')
        print('|----------|--------|--------------|')
        for r in results:
            status_emoji = '‚úÖ' if r['status'] == 'healthy' else '‚ùå' if r['status'] == 'unhealthy' else '‚ö†Ô∏è'
            print(f'| {r['provider']} | {status_emoji} {r['status']} | {r['latency_ms']:.0f} |')
        
        # Save to file
        with open('AI_HEALTH_STATUS.md', 'w') as f:
            f.write(result)
        
        # Exit with error if < 3 healthy providers
        sys.exit(0 if len(healthy) >= 3 else 1)
        " > health_report.md
        
        cat health_report.md >> $GITHUB_STEP_SUMMARY
    
    - name: Commit health status
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add AI_HEALTH_STATUS.md
        git commit -m "üè• Update AI providers health status" || echo "No changes"
        git push
    
    - name: Create alert issue if critical
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'üö® AI Providers Health Critical',
            body: `Less than 3 healthy AI providers detected!\n\nCheck the [health status](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/blob/main/AI_HEALTH_STATUS.md) for details.`,
            labels: ['critical', 'infrastructure']
          });
