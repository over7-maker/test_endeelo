name: "00 - Zero-Failure Master Orchestrator"

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Orchestration Mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - analysis
          - security
          - quality

env:
  PYTHON_VERSION: '3.11'

jobs:
  initialize:
    name: "Initialize Orchestration"
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.setup.outputs.run_id }}
      mode: ${{ steps.setup.outputs.mode }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Orchestration
        id: setup
        run: |
          RUN_ID="orchestration-$(date +%Y%m%d-%H%M%S)"
          MODE="${{ github.event.inputs.mode || 'full' }}"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "mode=$MODE" >> $GITHUB_OUTPUT

  project-analysis:
    name: "Project Analysis"
    needs: initialize
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Project Analysis
        env:
          GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
          GROQ2_API_KEY: ${{ secrets.GROQ2_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
          GEMINI2_API_KEY: ${{ secrets.GEMINI2_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          CHUTES_API_KEY: ${{ secrets.CHUTES_API_KEY }}
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
          GPTOSS_API_KEY: ${{ secrets.GPTOSS_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
        run: |
          python .github/scripts/run_project_analysis.py

      - name: Upload Analysis
        uses: actions/upload-artifact@v4
        with:
          name: project-analysis
          path: project_analysis.md
          retention-days: 90

  code-quality:
    name: "Code Quality Analysis"
    needs: initialize
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Tools
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint flake8 bandit

      - name: Run Quality Checks
        continue-on-error: true
        run: |
          python .github/scripts/run_code_quality.py

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: |
            quality_reports.md
          retention-days: 90

  security-scanner:
    name: "Security Scanner"
    needs: initialize
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Security Tools
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit

      - name: Run Security Scans
        env:
          GROQAI_API_KEY: ${{ secrets.GROQAI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GEMINIAI_API_KEY: ${{ secrets.GEMINIAI_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        continue-on-error: true
        run: |
          python .github/scripts/run_security_analysis.py

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security_analysis.md
          retention-days: 90

  finalize:
    name: "Finalize Orchestration"
    needs: [initialize, project-analysis, code-quality, security-scanner]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate Summary
        run: |
          echo "# Orchestration Summary" > summary.md
          echo "Run ID: ${{ needs.initialize.outputs.run_id }}" >> summary.md
          echo "Mode: ${{ needs.initialize.outputs.mode }}" >> summary.md
          cat summary.md

      - name: Complete
        run: |
          echo "Orchestration complete!"
